!function(a){a.fn.jcustomtag=function(t){var n=this,e=a(n),s={placeholder:"Enter tags ...",addTagButton:{id:"btnTagAdder",class:"btn btn-success btn-sm mtop10",name:"btnTagAdder",text:"Add tag"},src:{ajax:{}},array_tags_init:[]},i=[],r=[],c=function(a){return a=a.toLowerCase(),a=a.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"),a=a.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"),a=a.replace(/ì|í|ị|ỉ|ĩ/g,"i"),a=a.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"),a=a.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"),a=a.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"),a=a.replace(/đ/g,"d")},d=function(t){a.each(t,function(a,t){""!==t&&(l(t),o(t),u())})},l=function(a){var t=e.parent();$_src_tagsList=t.find("._src_tagsList"),$_src_t=$_src_tagsList.find("li[data-value='"+a+"']"),$_src_t.length>0&&!$_src_t.hasClass("hidden")&&$_src_t.addClass("hidden")},o=function(a){var t=e.parent(),n=t.find(".tagsList");n.append(["<span class='tag'>",a,"\t\t<button type='button' class='close'>×</button>","</span>"].join("")),n.find(".tag:last-child").data("tag",a)},g=function(){e.val("")},u=function(){var a=e;a.length>0&&a.val(r.join(","))},f=function(t){var n=e.parent(),s=n.prev(".tagErrorBox");0===s.length&&(a("<div class='tagErrorBox'></div>").insertBefore(n),s=n.prev(".tagErrorBox")),s.html(t)},v=function(a){a.preventDefault();var t=e.parent(),n=t.find("._txtTagInput"),s=-1,i=n.val().toString().trim();""!==i?(s=r.findIndex(function(a){return a.toString()===i}),s===-1?(l(i),o(i),r.push(i),u(),f("")):f("Tag đã được thêm vào, mời chọn tag khác.")):f("Mời nhập nội dung cho tag."),n.val("").focus()},h=function(t){t.preventDefault();var n=e.parent(),s=n.find("._src_tagsList");n.find("._txtTagInput").val(a(this).closest("li").data("value").toString()),v(t),s.removeClass("active")},p=function(t,n,s){var i=e,c=i.parent();if(Object.keys(t).length>0){var l=c.find("._src_tagsList"),o=c.find(".tagsList");0===l.length&&(l=a("<ul class='_src_tagsList dropdown-menu'></ul>"),l.appendTo(c)),l.html(""),o.html(""),a.each(t,function(a,t){var n=["<li data-value='{tag_name}'>","\t<a href='#'>{tag_name}</a>","</li>"].join("");n=n.replace(/\{tag_name\}/gi,t.name),l.append(n)}),"reinit"!==s?n.length>0&&d(n):(r=[],g()),l.find("a").unbind("click",h).bind("click",h)}},_={$tagName:e,ready:function(){var n=this.$tagName,e=null,l=function(){},o=function(){},g=function(t){var n=t||window.event,s=e.find("._src_tagsList");if(13===n.which)n.preventDefault();else if(27===n.which)s.length>0&&s.hasClass("active")&&s.removeClass("active");else if(s.length>0){var d=a(this).val();if(""!==d){d=c(d);var l=i.filter(function(a){var t=c(a.name);return t.indexOf(d)!==-1});l.length>0?s.find("li").each(function(t,n){var e=a(n).data("value").toString(),i=c(e);if(i.indexOf(d)===-1?a(n).hasClass("hidden")||a(n).addClass("hidden"):r.indexOf(e)!==-1?a(n).hasClass("hidden")||a(n).addClass("hidden"):a(n).hasClass("hidden")&&a(n).removeClass("hidden"),!s.hasClass("active")){var l=s.find("li:not(.hidden)").length;l>0&&s.addClass("active")}}):s.hasClass("active")&&s.removeClass("active")}else s.hasClass("active")&&s.removeClass("active")}},f=function(a){var t=n.closest(".tags").find("._src_tagsList");t.is(a.target)||0!==t.has(a.target).length||t.removeClass("active")},v=function(t){t.preventDefault();var n=a(this).closest("span.tag"),s=e.find("._src_tagsList");tag_name=n.data("tag"),$_tag=s.find("li[data-value='"+tag_name+"']"),tag_index=r.findIndex(function(a){return a===tag_name}),n.remove(),r.splice(tag_index,1),$_tag.length>0&&$_tag.hasClass("hidden")&&$_tag.removeClass("hidden"),u()};a.extend(s,t),n.addClass("hidden").wrap('<div class="tags"></div>'),e=n.parent(),e.append("<div class='tagsList'></div>").append("<input class='_txtTagInput' type='text' placeholder='"+s.placeholder+"'>").on("focus","._txtTagInput",l).on("blur","._txtTagInput",o).on("keyup","._txtTagInput",g).on("click touchstart",".close",v),a(document).on("mouseup touchstart",f);var h=n.closest(".field").find(".ajaxLoadTags");h.addClass("active"),setTimeout(function(){Object.keys(s.src.ajax).length>0?a.ajax(s.src.ajax).done(function(a){i=a,r=s.array_tags_init,p(i,r,""),h.removeClass("active")}):(r=s.array_tags_init,r.length>0&&d(r),h.removeClass("active"))},200)}};return _.ready(),{render:function(){d(r)},appendTag:function(a){r.push(a)},appendTagsList:function(t){a.each(t,function(a,t){r.push(t)})},getTagsList:function(){return r},reloadWithNewAjax:function(t){var n=e.closest(".field").find(".ajaxLoadTags");n.addClass("active"),setTimeout(function(){a.ajax(t).done(function(a){p(a,[],"reinit"),n.removeClass("active")})},200)}}}}(jQuery);